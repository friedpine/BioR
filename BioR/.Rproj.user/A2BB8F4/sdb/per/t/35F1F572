{
    "contents" : "library(data.table)\nlibrary(RODBC)\nlibrary(plyr)\n\nSNV_finder = function(channel,samples,control_id,control_type,tablename,target_tables,depth,target_depth,alt_ratio){\n  controls = samples[control_id]\n  targets = samples[-control_id]\n  samples_DP = paste(\",\",samples,\"_DP\",sep=\"\",collapse=\"\")\n  sql_head = paste(\"select chr,pos,Ref,Alt,Qual,DP,DP_alt\",samples_DP,\" from\",tablename,\"where\",sep=\" \")    \n  cond_depth = paste(samples,\"_DP>=\",depth,\" and \",sep=\"\",collapse = '')\n  cond_control_type = paste(controls,\"_G = '\",control_type,\"' and \",sep=\"\",collapse = '')\n  cond_control_qual = paste(\"(\",controls,\"_GQ>95 or \",controls,\"_GQ>3*\",controls,\"_DP) and \",sep=\"\",collapse = '')\n  sql_command = gsub(\" and $\",\";\",paste(sql_head,cond_depth,cond_control_type,cond_control_qual))\n  print(sql_command)\n  SNV_Depth_Ctrl_Type = sqlQuery(channel,sql_command)\n  SNV_Depth_Ctrl_Type$POS = paste(as.character(SNV_Depth_Ctrl_Type$chr),SNV_Depth_Ctrl_Type$pos,sep=\":\")\n  INFO_Targets = list()\n  sql_target = function(char1,int2,int3){paste(\"select chr,pos,DP,DP_alt from \",char1,\" where DP>=\",int2,\" and DP_alt>=\",int3,\" and DP_alt>=DP*\",alt_ratio,sep=\"\")}\n  INFO_Targets = lapply(target_tables,function(x){sqlQuery(channel,sql_target(x,depth,target_depth))})\n  INFO_Targets = llply(INFO_Targets,function(x) cbind(DP=x$DP,DP_alt=x$DP_alt,POS=paste(x$chr,x$pos,sep=\":\")))\n  INFO_Targets[[length(INFO_Targets)+1]] = SNV_Depth_Ctrl_Type\n  merged = Reduce(function(...) merge(...,by=\"POS\",all=F),INFO_Targets)\n  merged_info = llply(INFO_Targets,function(x) length(merge(x,INFO_Targets[[length(INFO_Targets)]],by=\"POS\")$POS))\n  names(merged_info) = c(targets,\"SNV_Depth_Ctrl_Type\")\n  infos = append(list(depth=depth,ratio=alt_ratio,target_depth=target_depth,overlap=length(merged$POS)),merged_info)\n  return(list(infos,merged))\n}\n\n\nSNV_Double_Hit = function(channel,samples,tablename,target_tables,depth,target_depth,alt_ratios,ratio_rec){\n  samples_DP = paste(\",\",samples,\"_DP\",sep=\"\",collapse=\"\")\n  sql_head = paste(\"select chr,pos,Ref,Alt,Qual,DP,DP_alt\",samples_DP,\" from\",tablename,\"where\",sep=\" \")    \n  cond_depth = paste(samples,\"_DP>=\",depth,\" and \",sep=\"\",collapse = '')\n  sql_command = gsub(\" and $\",\";\",paste(sql_head,cond_depth))\n  print(sql_command)\n  SNV_Depth_Ctrl_Type = sqlQuery(channel,sql_command)\n  SNV_Depth_Ctrl_Type$POS = paste(as.character(SNV_Depth_Ctrl_Type$chr),SNV_Depth_Ctrl_Type$pos,sep=\":\")\n  INFO_Targets = list()\n  sql_target = function(char1,sample,int2,int3,range){a = paste(\"select chr,pos,DP as \",sample,\"_DP,DP_alt as \",sample,\"_DP_alt from \",char1,\" where DP>=\",int2,\" and DP_alt>=\",int3,\" and DP_alt>=DP*\",range[1],\" and DP_alt<=DP*\",range[2],sep=\"\");print(a)}\n  INFO_Targets = lapply(1:length(samples),function(x){sqlQuery(channel,sql_target(target_tables[x],samples[x],depth,target_depth,alt_ratios[[x]]))})\n  INFO_Targets = llply(INFO_Targets,function(x) cbind(DP=x$DP,DP_alt=x$DP_alt,POS=paste(x$chr,x$pos,sep=\":\")))\n  INFO_Targets[[length(INFO_Targets)+1]] = SNV_Depth_Ctrl_Type\n  merged = Reduce(function(...) merge(...,by=\"POS\",all=F),INFO_Targets)\n  merged_info = llply(INFO_Targets,function(x) length(merge(x,INFO_Targets[[length(INFO_Targets)]],by=\"POS\")$POS))\n  names(merged_info) = c(samples,\"SNV_Depth_Ctrl_Type\")\n  infos = append(list(depth=depth,ratio=ratio_rec,target_depth=target_depth,overlap=length(merged$POS)),merged_info)\n  return(list(infos,merged))\n}\n\nSNV_Tested_by_Other_Method = function(SNVs,tables_names){\n  \n}\n\n\n\n\n",
    "created" : 1408934969222.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "75940143",
    "id" : "35F1F572",
    "lastKnownWriteTime" : 1408977250,
    "path" : "~/GitHub/BioR/BioR/SNV_analysis.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : true,
    "type" : "r_source"
}